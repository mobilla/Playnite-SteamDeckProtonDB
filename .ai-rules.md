# AI Rules for Steam Deck & ProtonDB Plugin

## TL;DR - Critical Rules
1. **Build/Test**: Always use `./SteamDeckProtonDb/restore-and-build.ps1` (auto-verifies XAML)
2. **XAML**: Uses runtime loading, NOT compiled. Must have `CopyToOutputDirectory=PreserveNewest`
3. **Constructor**: Strip `x:Class` before XamlReader.Load(), no `InitializeComponent()`
4. **Tests**: Add to SteamDeckProtonDb.Tests/, auto-run via restore-and-build.ps1

## Settings View (XAML/Code-Behind) Rules

### Project Configuration (.csproj)

1. **XAML Resource Deployment**
   - `SteamDeckProtonDbSettingsView.xaml` MUST have `<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>` in the `<None>` ItemGroup
   - Do NOT use `<Page>` compilation if the application uses `dotnet build` (MSBuild XAML compilation is not reliable with dotnet)
   - Verify the XAML file exists in `bin/Debug/` and `bin/Release/` after every build

2. **Compile Includes**
   - Do NOT include generated `.g.cs` files (e.g., `SteamDeckProtonDbSettingsView.g.cs`) in `<Compile>` ItemGroup
   - Let the code-behind constructor handle XAML loading at runtime instead

### Code-Behind Pattern (SteamDeckProtonDbSettingsView.xaml.cs)

1. **Constructor Implementation**
   - The constructor MUST NOT call an auto-generated `InitializeComponent()` from XAML compilation
   - Instead, implement a custom initialization that:
     - **First**: Attempts to load via pack URI for built-in resource compatibility
     - **Second**: Falls back to loading the XAML file from the assembly output directory
     - **Third**: Provides a minimal fallback UI (StackPanel with error text) if both methods fail
   - All three paths MUST be wrapped in try-catch blocks with graceful error handling

2. **x:Class Attribute Stripping**
   - When loading XAML from file at runtime, MUST strip the `x:Class` attribute before parsing
   - Use regex to remove: `\s+x:Class=\"[^\"]*\"`
   - This prevents recursion and type binding conflicts
   - Do this inside the StringReader phase, before XamlReader.Load()

3. **Required Imports**
   - Include: `System.Reflection`, `System.IO`, `System.Xml`, `System.Windows.Markup`, `System.Text.RegularExpressions`

### XAML Design

1. **Binding Support**
   - Ensure all UI bindings target properties on the `ISettings` object (e.g., `Text="{Binding EnableSteamDeckCategories}"`)
   - Playnite sets the DataContext to the settings object automatically; do NOT set it in code-behind
   - Test all bindings by instantiating `new SteamDeckProtonDbSettingsView()` and verifying `Content` is not null

### Testing Requirements

1. **Unit Tests**
   - `SettingsApplicationTests` or similar MUST instantiate `new SteamDeckProtonDbSettingsView()` and verify:
     - Constructor does not throw
     - `Content` property is not null
     - DataContext is null (Playnite will set it)
   - Test after any XAML layout or code-behind changes

2. **Integration Tests**
   - Verify settings view opens in Playnite UI without "Failed to load settings view" error
   - Confirm all bindings reflect the actual `SteamDeckProtonDbSettings` state
   - Check that Save/Cancel buttons in Playnite settings dialog work

### Deployment

1. **Binary Distribution**
   - When releasing or deploying the plugin, ensure BOTH files are copied to Playnite's extensions folder:
     - `SteamDeckProtonDb.dll`
     - `SteamDeckProtonDbSettingsView.xaml`
   - Verify file timestamps match (both from the same build output)

2. **Build Process**
   - Always use `dotnet build` for release builds
   - Verify `bin/Debug/` and `bin/Release/` contain the XAML file before deployment
   - Do not rely on MSBuild XAML compilation steps

### Debugging & Diagnostics

1. **Error Logging**
   - If the fallback path is taken (runtime XAML load), consider logging:
     - Which URI patterns were attempted
     - The assembly location and XAML file path checked
     - Whether the file exists and was successfully loaded
   - This helps diagnose deployment or build issues

2. **Common Issues**
   - **"Cannot locate resource 'steamdeckprotondbsettingsview.xaml'"**: XAML file not copied to output. Check `.csproj` CopyToOutputDirectory setting.
   - **"Failed to create a 'Click' from the text..."**: XAML references a code-behind method that doesn't exist. Remove or implement missing event handlers.
   - **"Failed to load Settings XAML"**: Constructor error. Ensure try-catch blocks are in place and fallback UI is provided.

### Related Files

- [SteamDeckProtonDbSettingsView.xaml](./SteamDeckProtonDb/SteamDeckProtonDbSettingsView.xaml) — UI definition
- [SteamDeckProtonDbSettingsView.xaml.cs](./SteamDeckProtonDb/SteamDeckProtonDbSettingsView.xaml.cs) — Code-behind with runtime loader
- [SteamDeckProtonDb.csproj](./SteamDeckProtonDb/SteamDeckProtonDb.csproj) — Project configuration
- [SettingsApplicationTests.cs](./SteamDeckProtonDb.Tests/SettingsApplicationTests.cs) — Settings view unit tests

## General Plugin Rules

1. **ISettings Implementation**
   - Follow [Playnite Plugin Settings Best Practices](https://api.playnite.link/docs/tutorials/extensions/pluginSettings.html)
   - Implement `BeginEdit()`, `EndEdit()`, `CancelEdit()`, and `VerifySettings()` properly
   - Load and save settings via `plugin.LoadPluginSettings<T>()` and `plugin.SavePluginSettings()`

2. **Code Changes to Settings View**
   - Any change to `SteamDeckProtonDbSettingsView.xaml` layout, bindings, or resources MUST be followed by:
     - `dotnet clean && dotnet build`
     - Verification that `bin/Debug/SteamDeckProtonDbSettingsView.xaml` exists
     - Manual test opening settings in Playnite
     - Unit test pass (`SettingsApplicationTests` or similar)

3. **Review Checklist**
   - [ ] XAML file copied to output (`<CopyToOutputDirectory>` in .csproj)
   - [ ] No `.g.cs` file in `<Compile>` ItemGroup
   - [ ] Code-behind constructor has three fallback paths (pack URI → file → placeholder)
   - [ ] x:Class attribute stripped before runtime XAML load
   - [ ] All bindings use valid property names on `SteamDeckProtonDbSettings`
   - [ ] Settings view tests pass
   - [ ] Plugin settings open without error in Playnite UI
